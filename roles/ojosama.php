<?php
// roles/ojosama.php
declare(strict_types=1);

/**
 * お嬢様語（ルール変換）
 * 方針：
 * 1) 正規化（改行など）
 * 2) 辞書（強い表現→上品に緩和）
 * 3) 依頼表現（ください等）を丁寧化
 * 4) 語尾（です/ます）を「ですわ/ますわ」などに寄せる
 */

function convert_to_ojosama(string $text): string
{
    // 1) 正規化
    $t = str_replace(["\r\n", "\r"], "\n", $text);
    $t = trim($t);

    if ($t === '') return $t;

    // 2) 強い表現の緩和（辞書）
    $dict = [
        '/ふざけるな/u' => 'まあ、そのようなことはお控えくださいませ',
        '/最悪/u' => 'たいへん残念ですわ',
        '/ありえない/u' => '少々理解に苦しゅうございます',
        '/むかつく/u' => '少々不快でございます',
        '/舐めてる/u' => '軽んじられているようで心外ですわ',
        '/遅すぎ(る|ます)/u' => '少々遅いように存じます',
        '/いい加減に(しろ|して)/u' => 'お猿さん以下ではなくって？',
        '/今すぐ/u' => 'わたくし、お花摘みに行きたいので',
        '/返金して(ください)?/u' => '返金のご対応をお願いできますでしょうか',
        '/交換して(ください)?/u' => '交換のご対応をお願いできますでしょうか',
        '/謝れ/u' => 'ご説明とご対応をお願いできますでしょうか',
    ];
    foreach ($dict as $pattern => $replacement) {
        $t = preg_replace($pattern, $replacement, $t);
    }

    // 3) 依頼表現の丁寧化（ざっくり）
    // 「〜してください」→「〜していただけますかしら」
    $t = preg_replace('/(して|対応して|確認して)ください/u', '$1あそばせ？', $t);
    $t = preg_replace('/ください。/u', 'いただけますかしら。', $t);
    $t = preg_replace('/ください！/u', 'いただけますかしら！', $t);
    $t = preg_replace('/ください\?/u', 'いただけますかしら？', $t);

    // 4) 語尾の寄せ（です/ます系）
    $ending = [
        'です。' => 'ですわ。',
        'です！' => 'ですわ！',
        'です？' => 'ですの？',
        'ます。' => 'ますわ。',
        'ます！' => 'あそばせ？',
        'ました。' => 'ましたわ。',
        'でした。' => 'でしたわ。',
    ];
    $t = strtr($t, $ending);// strtrは連続置換しないので安心

    // 5) 句点ごとに少しだけ「らしさ」を足す（過剰にならない範囲）
    // 文頭に軽く入れる（毎回はくどいので、先頭だけ）
    if (!preg_match('/^(まあ|あら)/u', $t)) {// 先頭に「まあ」か「あら」がなければ
        $t = "まあ、{$t}";
    }

    // 最後が句点なしなら句点を補う（表示の見た目）
    if (!preg_match('/[。！？\?]\s*$/u', $t)) {
        $t .= '🌹';
    }

    return $t;
}
